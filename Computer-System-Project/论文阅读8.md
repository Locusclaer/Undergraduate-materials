# Spectre
## 1. 它是怎么传递信息的？
让 CPU 猜测未来可能的执行方向，并提前执行这些路径上的指令。若程序的控制流取决于外部物理内存中的某些未缓存值，该内存的速度远低于 CPU，为了不浪费闲置时间，提高程序运行速度，CPU 会尝试猜测控制流的方向，并保存寄存器的状态，按照猜测的方向试探性地执行程序。最终村内存中获取到值后，检查该值的正确性，若错误则回退到保存的寄存器状态，若正确则保存推测执行结果。但是即使最终由于分支判断恢复架构状态，但是之前泄漏的信息和修改的微架构状态不会恢复，利用这点就可以进行攻击，来获取受害者的机密信息，并通过侧信通道，将敏感信息传递出来。

## 2. 为什么不能直接通过内存或寄存器传递信息？
CPU 最终发现预测错误之后，会回滚到之前在分支处记录的寄存器状态，即内存与寄存器中的更改没有被保存下来，因而无法直接通过内存或寄存器来传递信息。

## 3. 什么是Spectre攻击？
Spectre 攻击会诱导 CPU 进行推测性地执行那些在正常程序执行过程中不被执行的指令序列，通过影响被诱导性执行的瞬态指令，能够从受害者的内存地址空间中通过隐秘侧信通道将信息泄露出去。

Spectre 攻击有几种变体：

1. 利用条件分支

攻击者会误导 CPU 的分支预测器，使其错误地预测分支的方向，从而导致 CPU 在一段时间内违背程序语义地执行原本不会执行的代码。

2. 利用间接分支

攻击者从受害者的地址空间中选取一个指令，并促使受害者推测性地执行该指令。攻击者并不依赖于受害程序中的漏洞，而是训练分支目标缓冲区（BTB）以在间接分支指令与指令地址之间产生错误的分支预测，从而导致指令的推测性执行。

3. 其他变体

还可以通过改变实现推测执行的方法以及泄露信息的方式来设计进一步的攻击。例如，篡改返回指令、通过时间变化泄露信息以及在算术单元上进行竞争等。

## 4. 它是怎么发生的？
从总体上看，Spectre 攻击会破坏内存隔离边界，它将推测执行与通过微架构隐蔽通道进行的数据泄露相结合。要发动 Spectre 攻击，攻击者会首先在进程地址空间中引入一系列指令，这些指令在执行时会充当隐蔽通道的发送器，从而泄露受害者的内存或寄存器内容。然后攻击者会诱导 CPU 进行推测性地错误执行这个指令序列，从而通过隐蔽通道泄露受害者的信息。攻击者最后再通过隐蔽通道获取受害者的信息。

## 5. 是什么原因使得该攻击变得可行？（或：为什么Intel不简单禁掉这项功能？）
因为 intel 需要 CPU 进行分支预测和推测执行的结果，并且在得到结果之后，BTB 会将最近执行的分支地址到目的地址进行保存，这就导致攻击可能发生。由于分支预测对性能的提升有很大的帮助，如果禁用会对性能造成很大的损伤，相比之下损失更大，因而不能简单禁用这项功能。